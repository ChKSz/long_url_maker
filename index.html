<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChKSz长链接生成器</title>
    <!-- 引入 Tailwind CSS 用于美化界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom font for better display */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide scrollbar for the textarea */
        #longLinkOutput {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #longLinkOutput::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Opera */
        }
        /* Style for the custom alert/message box */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            max-width: 90%;
            width: 400px;
            display: none; /* Hidden by default */
        }
        .message-box.show {
            display: block;
        }
        .message-box h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
        }
        .message-box p {
            font-size: 1rem;
            color: #555;
            margin-bottom: 1.5rem;
        }
        .message-box button {
            background-color: #667eea;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
        }
        .message-box button:hover {
            background-color: #764ba2;
        }
        /* Specific style for redirection message box */
        #redirectMessageBox {
            background: linear-gradient(135deg, #a7f3d0 0%, #6ee7b7 100%); /* Greenish gradient */
            color: #065f46;
            border: 2px solid #34d399;
        }
        #redirectMessageBox h3 {
            color: #065f46;
        }
        #redirectMessageBox p {
            color: #10b981;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 hover:scale-101">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-2 tracking-tight">好玩的长链接生成器</h1>
        <p class="text-center text-gray-600 text-lg mb-8">Made By <a href="https://github.com/ChKSz" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">ChKSz</a></p>

        <div class="mb-8">
            <label for="shortLinkInput" class="block text-gray-700 text-lg font-semibold mb-3">输入链接:</label>
            <input type="text" id="shortLinkInput" placeholder="https://example.com"
                   class="w-full p-4 border-2 border-blue-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-400 focus:border-transparent text-gray-800 text-lg transition duration-200 ease-in-out">
        </div>

        <button id="generateButton"
                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-75 text-xl">
            生成长链接
        </button>

        <!-- Loading indicator, shown during generation -->
        <div id="loadingIndicator" class="hidden text-center text-blue-600 font-semibold mt-6">
            正在生成中... 请稍候...
        </div>

        <!-- Error message display area -->
        <div id="errorMessage" class="hidden text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-6" role="alert">
            <strong class="font-bold">错误!</strong>
            <span class="block sm:inline" id="errorText"></span>
        </div>

        <div class="mt-10 p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner">
            <label for="longLinkOutput" class="block text-gray-700 text-lg font-semibold mb-3">生成的长链接:</label>
            <textarea id="longLinkOutput" rows="6" readonly
                      class="w-full p-4 border-2 border-gray-300 rounded-xl bg-gray-100 text-gray-800 text-lg resize-none focus:outline-none focus:ring-2 focus:ring-gray-400">等待输入...</textarea>
            <button id="copyButton"
                    class="mt-5 w-full bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:-translate-y-0.5 hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-green-400 focus:ring-opacity-75 text-lg">
                复制长链接
            </button>
            <!-- Copy success message -->
            <div id="copyMessage" class="hidden text-center text-green-600 font-semibold mt-3">
                已复制到剪贴板!
            </div>
        </div>

        <!-- GitHub open source link as a star emoji -->
        <div class="mt-8 text-center">
            <a href="https://github.com/chksz/long_url_maker" target="_blank"
               class="text-4xl text-gray-700 hover:text-gray-900 transition-colors duration-200 ease-in-out inline-block"
               title="在 GitHub 上查看此项目">
                <i class="fab fa-github"></i>
            </a>
        </div>
    </div>

    <!-- Custom Message Box for general errors/info -->
    <div id="messageBox" class="message-box hidden">
        <h3 id="messageBoxTitle"></h3>
        <p id="messageBoxContent"></p>
        <button id="messageBoxCloseButton">确定</button>
    </div>

    <!-- Redirection Message Box -->
    <div id="redirectMessageBox" class="message-box hidden">
        <h3 id="redirectMessageBoxTitle"></h3>
        <p id="redirectMessageBoxContent"></p>
    </div>

    <script>
        // ===================================================================
        // 请在此处修改您的配置，无需修改 config.json 文件
        // ===================================================================
        const config = {
            // 重要：此域名必须是您实际部署此HTML文件的域名！
            // 例如，如果您的文件部署在 https://yourdomain.com/index.html，则 domain 应为 "https://yourdomain.com"
            // 如果您在本地通过 live server 运行，则可能是 "http://127.0.0.1:5500" 或 "http://localhost:8000"
            "domain": window.location.origin, // 自动获取当前页面的协议和域名
            "zero": "l", // 小写 'l' 对应 0
            "one": "I"    // 大写 'I' 对应 1
        };
        // ===================================================================
        // 配置结束
        // ===================================================================

        // 获取 DOM 元素
        const shortLinkInput = document.getElementById('shortLinkInput');
        const generateButton = document.getElementById('generateButton');
        const longLinkOutput = document.getElementById('longLinkOutput');
        const copyButton = document.getElementById('copyButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const copyMessage = document.getElementById('copyMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const messageBox = document.getElementById('messageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseButton = document.getElementById('messageBoxCloseButton');
        const redirectMessageBox = document.getElementById('redirectMessageBox');
        const redirectMessageBoxTitle = document.getElementById('redirectMessageBoxTitle');
        const redirectMessageBoxContent = document.getElementById('redirectMessageBoxContent');

        /**
         * 显示错误信息（在页面顶部）
         * @param {string} message - 要显示的错误文本
         */
        function showErrorMessage(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        /**
         * 隐藏错误信息（在页面顶部）
         */
        function hideErrorMessage() {
            errorMessage.classList.add('hidden');
            errorText.textContent = '';
        }

        /**
         * 显示自定义消息框（替代 alert）
         * @param {string} title - 消息框标题
         * @param {string} content - 消息框内容
         * @param {function} onClose - 关闭时执行的回调函数 (可选)
         */
        function showMessageBox(title, content, onClose = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            messageBox.classList.add('show');
            messageBoxCloseButton.onclick = () => {
                messageBox.classList.remove('show');
                if (onClose) onClose();
            };
        }

        /**
         * 显示重定向提示框
         * @param {string} title - 提示框标题
         * @param {string} content - 提示框内容
         */
        function showRedirectMessage(title, content) {
            redirectMessageBoxTitle.textContent = title;
            redirectMessageBoxContent.textContent = content;
            redirectMessageBox.classList.add('show');
        }

        /**
         * 隐藏重定向提示框
         */
        function hideRedirectMessage() {
            redirectMessageBox.classList.remove('show');
        }

        // 字符串转二进制 (8位ASCII码)
        function stringToBinary(str) {
            return str.split('').map(char => {
                return char.charCodeAt(0).toString(2).padStart(8, '0');
            }).join('');
        }

        // 二进制转字符串
        function binaryToString(binary) {
            const chunks = binary.match(/.{8}/g) || [];
            return chunks.map(chunk => {
                return String.fromCharCode(parseInt(chunk, 2));
            }).join('');
        }

        // 二进制转自定义字符 (l 和 I)
        function binaryToCustomChars(binaryStr, zeroChar, oneChar) {
            return binaryStr.split('').map(bit => {
                return bit === '0' ? zeroChar : oneChar;
            }).join('');
        }

        // 自定义字符 (l 和 I) 转二进制
        function customCharsToBinary(customCharString, zeroChar, oneChar) {
            return customCharString.split('').map(char => char === zeroChar ? '0' : '1').join('');
        }

        /**
         * 编码URL和时间戳信息为自定义字符编码
         * @param {string} url - 目标URL
         * @returns {{encoded: string, data: object}} - 编码后的字符串和原始数据对象
         */
        function encodeUrlWithTimestamp(url) {
            const now = Date.now();
            
            // 将数据打包（永久链接，无过期时间）
            const data = {
                url: url,
                created: now,
                expires: null, // 永久链接
                permanent: true
            };
            
            const jsonData = JSON.stringify(data);
            
            // 转换为二进制
            const binary = stringToBinary(jsonData);
            
            // 转换为 i/I 编码 (使用配置中的 zero 和 one 字符)
            const encoded = binaryToCustomChars(binary, config.zero, config.one);
            
            return {
                encoded: encoded,
                data: data
            };
        }

        /**
         * 解码自定义字符字符串为原始数据对象
         * @param {string} customCharString - 自定义字符编码字符串
         * @returns {object|null} - 解码后的数据对象，如果失败则为 null
         */
        function decodeFromCustomChars(customCharString) {
            try {
                // 转换为二进制 (使用配置中的 zero 和 one 字符)
                const binary = customCharsToBinary(customCharString, config.zero, config.one);
                
                // 转换为字符串
                const jsonString = binaryToString(binary);
                
                // 解析JSON
                const data = JSON.parse(jsonString);
                
                return data;
            } catch (error) {
                console.error('解码失败:', error);
                return null;
            }
        }

        /**
         * 将长编码字符串分割成多段路径
         * @param {string} encoded - 长编码字符串
         * @returns {string} - 分段后的路径字符串，用 '/' 连接
         */
        function generateSegmentedPath(encoded) {
            const segments = [];
            const maxSegmentLength = 100; // URL段最大长度，可调整
            
            for (let i = 0; i < encoded.length; i += maxSegmentLength) {
                segments.push(encoded.substring(i, i + maxSegmentLength));
            }
            
            return segments.join('/');
        }

        /**
         * 从分段路径中提取完整的编码字符串
         * @param {string} path - URL路径部分
         * @returns {string} - 提取出的编码字符串
         */
        function extractEncodedFromPath(path) {
            return path.replace(/\//g, ''); // 移除所有 '/'
        }

        /**
         * 生成长链接的主函数
         */
        async function generateLongLink() {
            // 确保配置对象存在并包含必要属性
            if (!config || !config.domain || !config.zero || !config.one) {
                showErrorMessage("配置信息不完整或缺失。请检查 HTML 文件中的 'config' 对象。");
                return;
            }

            const shortLink = shortLinkInput.value.trim();
            if (!shortLink) {
                longLinkOutput.value = "请输入一个短链接！"; // 如果输入为空，显示此提示
                hideErrorMessage(); // 清除之前的错误信息
                return;
            }

            // 显示加载指示器
            loadingIndicator.classList.remove('hidden');
            longLinkOutput.value = ""; // 清除之前的输出
            hideErrorMessage(); // 清除之前的错误信息

            // 模拟异步操作以提供加载感
            await new Promise(resolve => setTimeout(resolve, 300));

            try {
                // 编码短链接和元数据
                const { encoded, data } = encodeUrlWithTimestamp(shortLink);

                // 生成分段路径
                const finalPath = generateSegmentedPath(encoded);

                // 结合域名和路径形成最终长链接
                const longLink = `${config.domain}/${finalPath}`;
                longLinkOutput.value = longLink;

            } catch (error) {
                showErrorMessage(`生成链接时发生错误: ${error.message}`);
                console.error("Error generating long link:", error);
            } finally {
                // 隐藏加载指示器
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * 复制长链接到剪贴板
         */
        function copyLongLink() {
            if (!longLinkOutput.value || longLinkOutput.value === "等待输入...") {
                showErrorMessage("没有可复制的链接。请先生成链接。");
                return;
            }
            // longLinkOutput.select(); // 移除此行，不再自动全选
            // 尝试使用现代 Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(longLinkOutput.value)
                    .then(() => {
                        copyMessage.classList.remove('hidden');
                        setTimeout(() => {
                            copyMessage.classList.add('hidden');
                        }, 2000); // 2秒后隐藏消息
                        hideErrorMessage(); // 复制成功时隐藏错误
                    })
                    .catch(err => {
                        console.error('使用 Clipboard API 复制文本失败:', err);
                        // 回退到旧的 document.execCommand
                        try {
                            const textArea = document.createElement('textarea');
                            textArea.value = longLinkOutput.value;
                            document.body.appendChild(textArea);
                            textArea.select(); // 仍然需要选中才能使用 execCommand
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            copyMessage.classList.remove('hidden');
                            setTimeout(() => {
                                copyMessage.classList.add('hidden');
                            }, 2000); // 2秒后隐藏消息
                            hideErrorMessage(); // 复制成功时隐藏错误
                        } catch (fallbackErr) {
                            showErrorMessage("复制失败: 您的浏览器不支持自动复制。请手动复制。");
                            console.error('回退复制失败:', fallbackErr);
                        }
                    });
            } else {
                // 旧的 document.execCommand 方法
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = longLinkOutput.value;
                    document.body.appendChild(textArea);
                    textArea.select(); // 仍然需要选中才能使用 execCommand
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    copyMessage.classList.remove('hidden');
                    setTimeout(() => {
                        copyMessage.classList.add('hidden');
                    }, 2000); // 2秒后隐藏消息
                    hideErrorMessage(); // 复制成功时隐藏错误
                } catch (err) {
                    showErrorMessage("复制失败: 您的浏览器不支持自动复制。请手动复制。");
                    console.error('复制命令失败:', err);
                }
            }
        }

        // 页面加载时自动解码和跳转功能
        window.addEventListener('load', function() {
            const currentUrl = window.location.href;
            const urlPath = window.location.pathname;
            
            // 如果当前页面URL包含编码路径，自动解码并跳转
            // 检查 urlPath 是否存在，不是根路径，且长度大于某个阈值（避免解码无意义的短路径）
            if (urlPath && urlPath !== '/' && urlPath.length > 5) { // 调整阈值以适应你的编码最短长度
                try {
                    // 提取路径部分
                    const path = urlPath.substring(1); // 移除开头的 /
                    
                    // 提取编码
                    const encoded = extractEncodedFromPath(path);
                    
                    // 解码
                    const decoded = decodeFromCustomChars(encoded);
                    
                    if (decoded && decoded.url) {
                        // 显示重定向提示框
                        showRedirectMessage('正在跳转...', `即将为您跳转到: ${decoded.url}`);
                        
                        // 永久链接，延迟跳转
                        setTimeout(() => {
                            window.location.href = decoded.url;
                        }, 1500); // 停留1.5秒后自动跳转
                        return; // 阻止后续页面内容的加载和生成器界面的显示
                    } else {
                        // 解码失败但没有抛出错误，可能是格式不正确
                        showMessageBox('链接无效', '抱歉，您访问的链接无效或已损坏。');
                    }
                } catch (error) {
                    // 解码失败，显示错误页面或消息
                    console.error("URL解码失败:", error);
                    showMessageBox('链接无效', '抱歉，您访问的链接无效或已损坏。');
                }
                // 如果尝试重定向但失败（显示了消息框），则不显示生成器表单
                return;
            }

            // 如果没有路径或路径不符合解码条件，则正常显示生成器页面
            // shortLinkInput.value = "https://long.chksz.top"; // 示例短链接，可以取消注释
            // generateLongLink(); // 初始不自动生成，等待用户输入
        });

        // 绑定事件监听器
        generateButton.addEventListener('click', generateLongLink);
        copyButton.addEventListener('click', copyLongLink);

        // 页面加载时，设置输出框的初始文本
        window.onload = () => {
            longLinkOutput.value = "等待输入...";
        };
    </script>
</body>
</html>
